# Начало работы с Microsoft Graph и REST

В этой статье описывается вызов Microsoft Graph для получения электронных сообщений в Office 365 и Outlook.com. Эта статья посвящена запросам и ответам OAuth и REST. В ней описывается последовательность запросов и ответов, которую приложение использует для проверки подлинности и получения сообщений.

## Проверка подлинности с помощью OAuth 2.0

Для вызова Microsoft Graph приложению необходим маркер доступа из Azure Active Directory (Azure AD). В приведенном ниже примере показано, что для получения этого маркера в приложении реализуется поток предоставления кода авторизации в соответствии со стандартными [протоколами OAuth 2.0](http://tools.ietf.org/html/rfc6749).

### Регистрация приложения

В настоящее время существует два способа регистрации приложения:

  1. Регистрация приложения с использованием модели, предназначенной для коммерческих пользователей Office 365 (только рабочих и учебных учетных записей).
 
  Эта модель подходит только для коммерческих предложений Office 365. Зарегистрировав приложение, вы можете управлять им на [портале управления Azure](https://manage.windowsazure.com).

  2. Регистрация с помощью новых функций, которые подходят как для коммерческих, так и некоммерческих служб Office 365 (назовем это конечной точкой OAuth версии 2.0).
 
  Теперь доступна единая служба аутентификации рабочих, учебных и личных учетных записей. Эта модель предусматривает единую аутентификацию как рабочих и учебных (Azure AD), так и личных (Майкрософт) учетных записей. Теперь в приложении необходимо реализовать поток аутентификации, чтобы пользователи могли использовать либо рабочие и учебные (Office 365 или OneDrive для бизнеса), либо личные учетные записи (Outlook.com или OneDrive).
   
На [портале регистрации приложений](https://apps.dev.microsoft.com/) можно зарегистрировать приложение с поддержкой как рабочих и учебных, так и личных учетных записей.

Обратите внимание, что конечная точка версии 2.0 постепенно развивается, чтобы обеспечить поддержку всех сценариев для предыдущей конечной точки аутентификации. Чтобы выбрать подходящий метод, прочитайте [эту статью](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-limitations/).

После регистрации вы получите идентификатор клиента и секрет клиента. Эти значения используются для потока предоставления кода авторизации.

В остальной части документа предполагается, что приложение зарегистрировано с помощью модели версии 2.0. Полное руководстве по потокам, поддерживаемым конечной точкой версии 2.0, см. в [этой статье](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-flows/). Полное руководство по потоку предоставления кода авторизации представлено в [этой статье](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-protocols-oauth-code/).

### Получение кода авторизации

Чтобы использовать поток предоставления кода авторизации, сначала необходимо получить код. Приложение получает код с сервера авторизации, когда пользователь входит и подтверждает необходимый уровень доступа.

Сначала приложение создает URL-адрес для входа пользователя. Этот URL-адрес нужно открыть в браузере, чтобы пользователь мог войти и предоставить требуемые разрешения.

Базовый URL-адрес для входа выглядит так: `https://login.microsoftonline.com/common/oauth2/v2.0/authorize`.

Приложение добавляет параметры запроса в базовый URL-адрес, чтобы сервер авторизации мог определить, какое приложение запрашивает вход и какие разрешения ему требуются.

- `client_id` — идентификатор клиента, создаваемый при регистрации приложения. С его помощью Azure AD определяет приложения, которые запрашивают вход.
- `redirect_uri` — адрес, на который Azure перенаправит пользователя после того, как он предоставит приложению разрешение. Это значение должно соответствовать значению **URI перенаправления**, которое использовалось при регистрации приложения.
- `response_type` — тип ответа, который ожидается приложением. Для потока предоставления кода авторизации используется значение `code`.
- `scope` — разделенный пробелами список разрешений, запрашиваемых приложением. Дополнительные сведения см. в [этой статье](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-scopes/).
- `state` — включенное в запрос значение, которое также возвращается в ответе токена.

Например, URL-адрес запроса для нашего приложения, которому требуется доступ на чтение почты, будет выглядеть так:

```http
GET https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=<CLIENT ID>&redirect_uri=http%3A%2F%2Flocalhost/myapp%2F&response_type=code&state=1234&scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
```

После этого пользователь перенаправляется на страницу URL-адреса для входа. Отображается экран входа и название приложения. После входа отображается список разрешений, и пользователь должен разрешить или запретить доступ для приложения. Если он разрешит доступ, браузер будет перенаправлен на URI, указанный в первом запросе с кодом авторизации в строке запроса.

```http
http://localhost/myapp/?code=AwABAAAA...cZZ6IgAA&state=1234
```

Если вы также используете OpenId Connect для единого входа, необходимы дополнительные параметры. Подробные сведения см. в [этой статье](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-protocols-oidc/). 

Далее необходимо заменить возвращенный код авторизации на токен доступа.

### Получение токена доступа

Чтобы получить токен доступа, приложение помещает параметры, закодированные с использованием формы, в URL-адрес запроса на предоставление токена (`https://login.microsoftonline.com/common/oauth2/v2.0/token`). При этом применяются указанные ниже параметры.

- `client_id`. Идентификатор клиента, создаваемый при регистрации приложения.
- `client_secret`. Секрет клиента, создаваемый при регистрации приложения.
- `code`. Код авторизации, полученный на предыдущем шаге.
- `redirect_uri`. Это значение должно совпадать со значением, используемым в запросе кода авторизации.
- `grant_type`. Тип предоставления, используемый приложением. Для потока предоставления кода авторизации используется значение `code`.
- `scope` — разделенный пробелами список разрешений, запрашиваемых приложением. Дополнительные сведения см. в [этой статье](https://azure.microsoft.com/en-us/documentation/articles/active-directory-v2-scopes/).

URL-адрес запроса для нашего приложения с кодом, полученным на предыдущем этапе, будет выглядеть так:

```http
POST https://login.microsoftonline.com/common/oauth2/v2.0/token
Content-Type: application/x-www-form-urlencoded

{
  grant_type=authorization_code
  &code=AwABAAAA...cZZ6IgAA
  &redirect_uri=http%3A%2F%2Flocalhost%2Fmyapp%2F
  &resource=https%3A%2F%2Fgraph.microsoft.com%2F
  &scope=https%3A%2F%2Fgraph.microsoft.com%2Fmail.read
  &client\_id=<CLIENT ID>
  &client\_secret=<CLIENT SECRET>
}
```

Ответ сервера содержит полезные данные JSON, которые включают токен доступа.

```http
HTTP/1.1 200 OK
Content-Type: application/json; charset=utf-8

{
  "token_type":"Bearer",
  "expires_in":"3600",
  "access_token":"eyJ0eXAi...b66LoPVA",
  "scope":"https://graph.microsoft.com/mail.read",
  ...
}
```

Токен доступа находится в поле `access_token` полезных данных JSON. С помощью этого значения приложение задает заголовок Authorization, когда выполняет вызовы REST к API.

## Вызов Microsoft Graph

После получения маркера доступа приложение готово к вызову Microsoft Graph. Так как этот пример приложения получает сообщения, он будет использовать HTTP-запрос GET к конечной точке `https://graph.microsoft.com/v1.0/me/messages`.

### Параметры запроса

Вы можете управлять запросами GET в приложении с помощью параметров запроса OData. Рекомендуем использовать эти параметры для ограничения числа возвращаемых результатов, а также полей, возвращаемых для каждого элемента. 

В этом приложении сообщения отображаются в таблице, где указаны тема, отправитель, дата и время получения сообщения. Таблица содержит не более 25 строк: сообщения сортируются по дате получения от новых к старым. Для получения таких результатов приложение использует следующие параметры запроса:

- `$select`: задает только поля `subject`, `sender` и `dateTimeReceived`.
- `$top`: задает до 25 элементов.
- `$orderby`: сортирует результаты по полю `dateTimeReceived`.

В результате мы получаем следующий запрос:

```http
GET https://graph.microsoft.com/v1.0/me/messages?$select=subject,from,receivedDateTime&$top=25&$orderby=receivedDateTime%20DESC
Accept: application/json
Authorization: Bearer eyJ0eXAi...b66LoPVA
```

Теперь вы знаете, как вызывать Microsoft Graph, и можете создавать другие вызовы, необходимые для вашего приложения, используя справочник по API. Обратите внимание, что необходимые для вызовов разрешения настраиваются во время регистрации приложения.


