# Вызов Microsoft Graph в службе или управляющем приложении

В этой статье мы рассмотрим минимальный набор действий, необходимых для подключения одноклиентской службы или управляющего приложения к Office 365 и вызова API Microsoft Graph.

## Обзор

Чтобы вызвать API Microsoft Graph в службе или управляющем приложении, необходимо выполнить следующие задачи:

1. Зарегистрировать приложение в Azure Active Directory.
2. Запросить токен доступа из конечной точки выдачи токенов.
3. Использовать токен доступа в запросе к API Microsoft Graph.

## Регистрация приложения в Azure Active Directory

Прежде чем начать работу с Office 365, необходимо зарегистрировать свое приложение и настроить разрешения на использование служб Microsoft Graph. С помощью [средства регистрации приложений](https://dev.office.com/app-registration) вы можете с легкостью зарегистрировать свое приложение. 
Для управления приложением необходимо перейти на [портал управления Microsoft Azure](https://manage.windowsazure.com).

Инструкции по регистрации приложения вручную см. в разделе [Регистрация приложения веб-сервера на портале управления Azure](https://msdn.microsoft.com/en-us/office/office365/HowTo/add-common-consent-manually#bk_RegisterServerApp). Обратите внимание на следующие рекомендации:

* После регистрации приложения настройте его **разрешения**, необходимые для вашей службы или управляющей программы.

Запишите приведенные ниже значения на странице "Настройка" приложения Azure, так как они понадобятся для настройки потока OAuth в службе или управляющей программе.

* Идентификатор клиента (уникальный для приложения).
* Ключ приложения (уникальный для приложения).
* Конечная точка маркера OAuth 2.0 приложения
  * Чтобы найти это значение, нажмите *Просмотр конечных точек* в нижней части портала управления Azure на странице приложения. Конечная точка будет представлена в формате `https://login.microsoftonline.com/<tenantId>/oauth2/token`.

## Запрос маркера доступа из конечной точки выдачи маркеров

В отличие от клиентских приложений, служба или управляющее приложение не может управлять входом пользователя и авторизацией приложения. Поэтому в приложении необходимо реализовать поток предоставления клиентских учетных данных OAuth 2.0, который позволит ему использовать собственные учетные данные, идентификатор клиента и ключ приложения, для аутентификации при вызове Microsoft Graph без необходимости в олицетворении пользователя. Подробные сведения о потоке аутентификации см. в статье [Вызовы службы службой с использованием клиентских учетных данных](https://msdn.microsoft.com/en-us/library/azure/dn645543.aspx).

Отправьте HTTP-запрос POST в конечную точку выдачи маркеров с указанными ниже параметрами, заменив параметры `<clientId>` и `<clientSecret>` на идентификатор клиента и ключ приложения соответственно.

```http
POST https://login.microsoftonline.com/<tenantId>/oauth2/token HTTP/1.1
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials
&client_id=<clientId>
&client_secret=<clientSecret>
&resource=https://graph.microsoft.com
```

Ответ будет содержать маркер доступа и сведения об истечении срока действия.

```json
{ 
  "token_type": "Bearer",
  "expires_in": "3599",
  "scope": "User.Read",
  "expires_on": "1449685363",
  "not_before": "1449681463",
  "resource": "https://graph.microsoft.com",
  "access_token": "<token>"
}
```

## Использование токена доступа в запросе к API Microsoft Graph

Используя токен доступа, приложение может отправлять проверенные запросы в API Microsoft Graph. Приложение должно добавлять токен доступа в заголовок **Authorization** каждого запроса.

Например, служба и управляющая программа могут получить список всех пользователей клиента, если на портале управления Azure для них выбрано разрешение *Чтение полных профилей всех пользователей*. 

```http
GET https://graph.microsoft.com/v1.0/users
Authorization: Bearer <token>
```

Microsoft Graph — это единый API, с помощью которого можно взаимодействовать со всеми данными Майкрософт. Сведения о других возможностях API Microsoft Graph см. в [справочнике по API](http://graph.microsoft.io/docs/api-reference/v1.0).
